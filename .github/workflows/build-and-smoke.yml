name: build-and-smoke

on:
  push:
    branches: ["**"]
  pull_request:

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: ShellCheck
        run: |
          find scripts/ lockclaw-core/ -name '*.sh' \
            -exec shellcheck --severity=warning {} +

      - name: HARD FAIL — no unpinned versions in Dockerfile
        run: |
          # Skip comment lines (starting with #), match @latest/@next/@canary
          if grep -nE '@latest|@next|@canary' Dockerfile | grep -vE '^\d+:\s*#'; then
            echo "FAIL: Found unpinned @latest/@next/@canary in Dockerfile"
            echo "Pin every dependency to an exact version using ARG at the top of each stage."
            exit 1
          fi
          echo "PASS: All Dockerfile dependencies are pinned"

  audit:
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Make scripts executable
        run: |
          chmod +x scripts/*.sh
          chmod +x lockclaw-core/audit/*.sh

      - name: Port allowlist validation
        run: |
          # Verify all port allowlist files are valid JSON
          for f in lockclaw-core/policies/ports/*.json; do
            python3 -c "import json; json.load(open('$f'))" \
              || { echo "FAIL: Invalid JSON in $f"; exit 1; }
            echo "PASS: $f is valid JSON"
          done

  build:
    needs: lint
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [base, openclaw, ollama]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build image (${{ matrix.target }})
        run: >
          docker build
          --target ${{ matrix.target }}
          -t lockclaw:${{ matrix.target }}
          .

      - name: Start container (no elevated capabilities)
        run: |
          docker volume create lockclaw-data-${{ matrix.target }}
          docker run -d \
            --name lockclaw-${{ matrix.target }} \
            --read-only \
            --tmpfs /tmp \
            --tmpfs /run \
            --tmpfs /var/tmp \
            --security-opt no-new-privileges:true \
            --cap-drop ALL \
            -e LOCKCLAW_MODE=hobby \
            -v lockclaw-data-${{ matrix.target }}:/data \
            lockclaw:${{ matrix.target }}

      - name: Wait for services
        run: sleep 5

      - name: Run smoke tests
        run: |
          docker exec lockclaw-${{ matrix.target }} \
            /opt/lockclaw/scripts/test-smoke.sh

      - name: Verify preflight passed
        run: |
          docker logs lockclaw-${{ matrix.target }} 2>&1 | grep -q 'Pre-flight PASSED' \
            || { echo "FAIL: pre-flight did not pass"; exit 1; }
          echo "PASS: pre-flight passed"

      - name: HARD FAIL — no unexpected published ports
        run: |
          echo "=== Port Exposure Check (${{ matrix.target }}) ==="
          LISTENERS=$(docker exec lockclaw-${{ matrix.target }} \
            ss -tlnH 2>/dev/null | awk '{print $4}' || true)
          echo "All listeners: $LISTENERS"

          # Nothing should be on non-loopback by default.
          NON_LOOPBACK=$(echo "$LISTENERS" \
            | grep -v '127\.0\.0\.1' \
            | grep -v '\[::1\]' \
            | grep -v '^\*:' \
            || true)

          if [ -n "$NON_LOOPBACK" ]; then
            echo "FAIL: Unexpected non-loopback listeners:"
            echo "$NON_LOOPBACK"
            exit 1
          fi
          echo "PASS: All services are loopback-only (no published ports)"

      - name: Cleanup
        if: always()
        run: |
          docker rm -f lockclaw-${{ matrix.target }} 2>/dev/null || true
          docker volume rm lockclaw-data-${{ matrix.target }} 2>/dev/null || true

  fail-fast:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build openclaw image
        run: docker build --target openclaw -t lockclaw:openclaw .

      - name: Fail on missing read-only root
        run: |
          docker run --name ff-no-ro \
            --tmpfs /tmp --tmpfs /run --tmpfs /var/tmp \
            --security-opt no-new-privileges:true \
            --cap-drop ALL \
            -v ff-no-ro-data:/data \
            lockclaw:openclaw || true
          docker logs ff-no-ro 2>&1 | grep -q 'root filesystem is not read-only' \
            || { echo "FAIL: missing read-only root did not fail preflight"; exit 1; }

      - name: Fail on RW mount outside /data
        run: |
          mkdir -p /tmp/lockclaw-rw
          docker run --name ff-rw-mount \
            --read-only \
            --tmpfs /tmp --tmpfs /run --tmpfs /var/tmp \
            --security-opt no-new-privileges:true \
            --cap-drop ALL \
            -v ff-rw-mount-data:/data \
            -v /tmp/lockclaw-rw:/workspace \
            lockclaw:openclaw || true
          docker logs ff-rw-mount 2>&1 | grep -q 'RW mount outside allowed writable paths' \
            || { echo "FAIL: RW mount outside /data did not fail preflight"; exit 1; }

      - name: Fail on dangerous capability
        run: |
          docker run --name ff-cap \
            --read-only \
            --tmpfs /tmp --tmpfs /run --tmpfs /var/tmp \
            --security-opt no-new-privileges:true \
            --cap-drop ALL \
            --cap-add SYS_ADMIN \
            -v ff-cap-data:/data \
            lockclaw:openclaw || true
          docker logs ff-cap 2>&1 | grep -q 'dangerous capability present' \
            || { echo "FAIL: dangerous capability did not fail preflight"; exit 1; }

      - name: Fail on unexpected listener
        run: |
          docker run --name ff-listener \
            --read-only \
            --tmpfs /tmp --tmpfs /run --tmpfs /var/tmp \
            --security-opt no-new-privileges:true \
            --cap-drop ALL \
            -v ff-listener-data:/data \
            --entrypoint /bin/bash \
            lockclaw:openclaw \
            -lc "node -e \"require('net').createServer(()=>{}).listen(9999, '0.0.0.0'); setInterval(()=>{}, 1<<30)\" >/dev/null 2>&1 & exec docker-entrypoint.sh start" || true
          docker logs ff-listener 2>&1 | grep -q 'listening port :9999 is not allowlisted' \
            || { echo "FAIL: unexpected listener did not fail preflight"; exit 1; }

      - name: Cleanup fail-fast containers
        if: always()
        run: |
          for c in ff-no-ro ff-rw-mount ff-cap ff-listener; do
            docker rm -f "$c" 2>/dev/null || true
          done
          for v in ff-no-ro-data ff-rw-mount-data ff-cap-data ff-listener-data; do
            docker volume rm "$v" 2>/dev/null || true
          done
